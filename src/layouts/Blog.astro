---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import PictureZoom from "../components/PictureZoom.svelte";
import SpeakAloud from "../components/SpeakAloud/index.svelte";

import type { MarkdownHeading } from "astro";
import {
	DISCUSSION_SITES,
	type DiscussionSite,
	getMinuteLengthFromFile,
	getSlugs,
	type MdOrMdxFile,
} from "../data/blogs";

import "./blog/index.css";
import Tooltip from "../components/Tooltip/Tooltip.astro";
import { formatDate } from "../utils/formatDate";

interface Props {
	content: {
		pubDate: string;
		title: string;
		summary: string;
		recording?: string;
		discussions?: { site: DiscussionSite; url: string }[];
	};
	file: MdOrMdxFile | string;
	url: string;
	headings: MarkdownHeading[];
}
const { content, file, url, headings } = Astro.props;
const { pubDate, title, summary, recording, discussions } = content;

// Validate discussion sites at build time
if (discussions) {
	for (const disc of discussions) {
		if (!(disc.site in DISCUSSION_SITES)) {
			throw new Error(
				`Unknown discussion site "${disc.site}" in ${url}. ` +
				`Valid sites are: ${Object.keys(DISCUSSION_SITES).join(", ")}. ` +
				`Add the site to DISCUSSION_SITES in src/data/blogs.ts if it's a new platform.`
			);
		}
	}
}
const minuteLength = getMinuteLengthFromFile(file);
const slugs = await Astro.glob("../pages/blog/*.md*").then(getSlugs);
const postItems = slugs.map(({ title, url }) => [title, url] as const);
const isNote = url.startsWith("/notes/");
import Toc from "../components/Toc.astro";
---
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content={summary} />
		<meta name="author" content="EmNudge" />
		<meta name="keywords" content="EmNudge" />
		<meta name="color-scheme" content="dark light" />
		<script>
			if (localStorage.getItem("theme") === "light") {
				document.documentElement.classList.add("light");
			}
		</script>
		<link
			rel="alternate"
			type="application/rss+xml"
			href="/blog/rss.xml"
			title="RSS feed for my blog"
		/>
		<link rel="icon" href="/icons/icon_neon.webp" />
		<link rel="stylesheet" href="/app.css" />
		<title>{title}</title>
	</head>
	<body>
		<Header />
		<main>
			<div class="title-container">
				<h5>
					<span>{formatDate(pubDate)} â€¢ {minuteLength} minute read</span>
					{discussions && (
						<span class="discussions">
							{discussions.toSorted((a, b) => a.site.localeCompare(b.site)).map(disc => (
								<a href={disc.url} target="_blank" rel="noopener">
									<img class="icon-dark" src={DISCUSSION_SITES[disc.site].dark} alt={disc.site} />
									<img class="icon-light" src={DISCUSSION_SITES[disc.site].light} alt={disc.site} />
								</a>
							))}
						</span>
					)}
				</h5>
				<h1>{title}</h1>
				<p>{summary}</p>
				{recording && <SpeakAloud recording={recording} isDev={import.meta.env.DEV} client:only="svelte" />}
			</div>
			<article class={recording ? "with-audio" : undefined}>
				<Toc headings={headings} />
				<slot />
				{isNote && (
					<div class="end-note-container">
						<Tooltip>
							<div slot="main-content" class="end-note">
# end note
							</div>
							<div slot="tooltip-content">
								Notes don't always have a neat conclusion, unlike articles. That's why
								this is a note.
							</div>
						</Tooltip>
					</div>
				)}
			</article>
		</main>
		<Footer />
		<PictureZoom client:load />
		<script src="../components/CodeRunner/index.ts"></script>
		<ninja-keys></ninja-keys>
		<script type="module" define:vars={{ postItems }}>
			import { addCommandPaletteConditionally } from "/libraries/command-palette.js";
			addCommandPaletteConditionally(postItems);
		</script>
	</body>
</html>


<style>
  article:global(.js-enabled p > img),
  article:global(.js-enabled figure img) {
    transition: 0.25s;
  }
  article:global(.js-enabled p > img:hover),
  article:global(.js-enabled figure img:hover) {
    transform: scale(1.03);
    cursor: pointer;
  }
  .overlay-image {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000a;
  }
  .overlay-image img {
    max-height: 80%;
    max-width: 80%;
  }
  .title-container h5 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .title-container h1 {
    font-size: var(--font-huge);
  }
  .discussions {
    display: flex;
    gap: 0.5rem;
    padding-left: 0.5rem;
    border-left: 1px solid #fff3;
  }
  .discussions a {
    display: flex;
    align-items: center;
  }
  .discussions img {
    height: 0.85rem;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .discussions img:hover {
    opacity: 1;
  }
  .discussions .icon-light {
    display: none;
  }
  @media (prefers-color-scheme: light) {
    .discussions .icon-dark {
      display: none;
    }
    .discussions .icon-light {
      display: block;
    }
  }
  :global(:root.light) .discussions .icon-dark {
    display: none;
  }
  :global(:root.light) .discussions .icon-light {
    display: block;
  }
  .title-container p {
    font-size: var(--font-medium);
    margin-top: 0.5rem;
  }

  .end-note-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 2rem;
  }
  .end-note {
    text-align: center;
    color: var(--muted);
  }
</style>
